<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>セミナー一覧</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    #debug {
      background: rgba(0, 0, 0, 0.85);
      color: #0f0;
      font-size: 11px;
      padding: 10px;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 180px;
      overflow-y: scroll;
      z-index: 9999;
      /* ★本番リリース時は display: none にする */
      display: block;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      font-size: 18px;
      margin-top: 0;
      color: #2c3e50;
    }

    .date {
      color: #e67e22;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .info {
      font-size: 14px;
      line-height: 1.5;
      color: #666;
    }

    .btn {
      display: block;
      width: 100%;
      text-align: center;
      background-color: #06c755;
      color: white;
      padding: 12px 0;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      margin-top: 15px;
      cursor: pointer;
      border: none;
      font-size: 16px;
    }

    .btn.disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .btn:active {
      background-color: #05b34c;
    }

    .loading {
      text-align: center;
      margin-top: 50px;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="loading">読み込み中...</div>
  </div>
  <div id="debug">Debug Log:</div>

  <script>
    // ==========================================
    // ★ この3つだけ書き換える
    // ==========================================
    const LIFF_ID = '2009018264-Dw2kv4L9';
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyUjqY83pRshVoWoRJsCTWG8S1oiFLqzxqRZ69NoADNqkl1qnkf8iYyqT80OKskWA0IwA/exec';
    const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdvMlF-nnf3qgebUwI4JrcnKddfQgyww16uT2qmM9MxgOb4sg/viewform';
    // ==========================================

    const ENTRY_SEMINAR = 'entry.100643207';
    const ENTRY_USER = 'entry.1734163930';

    function log(msg) {
      console.log(msg);
      const d = document.getElementById('debug');
      if (d) d.innerHTML += '\n[' + new Date().toLocaleTimeString() + '] ' + msg;
    }

    function withTimeout(promise, ms) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error('TIMEOUT after ' + ms + 'ms')), ms))
      ]);
    }

    // ==========================================
    // Main
    // ==========================================
    async function main() {
      try {
        log('=== main start ===');
        log('URL: ' + window.location.href);
        log('Origin: ' + window.location.origin);
        log('LIFF ID: ' + LIFF_ID);

        // 1. LIFF 初期化
        log('Calling liff.init...');
        await withTimeout(liff.init({ liffId: LIFF_ID }), 10000);
        log('liff.init SUCCESS');

        log('isLoggedIn: ' + liff.isLoggedIn());
        log('isInClient: ' + liff.isInClient());
        log('OS: ' + liff.getOS());

        // 2. ログインチェック
        if (!liff.isLoggedIn()) {
          log('Not logged in');
          document.getElementById('app').innerHTML =
            '<div style="text-align:center; padding:20px;">' +
            '<p>LINEログインが必要です</p>' +
            '<button class="btn" onclick="liff.login()">LINEでログイン</button>' +
            '</div>';
          return;
        }

        // 3. プロフィール取得
        const profile = await liff.getProfile();
        const userId = profile.userId;
        log('UserID: ' + userId);
        log('Name: ' + profile.displayName);

        // 4. セミナー一覧取得
        loadSeminars(userId);

      } catch (err) {
        log('ERROR: ' + err.message);
        if (err.message.includes('TIMEOUT')) {
          document.getElementById('app').innerHTML =
            '<p>LIFF初期化がタイムアウトしました。</p>' +
            '<p style="font-size:12px;color:#999;">LINEアプリ内で開いてください。</p>';
        } else {
          document.getElementById('app').innerHTML = '<p>エラー: ' + err.message + '</p>';
        }
      }
    }

    // ==========================================
    // ★ 変更点: google.script.run → fetch()
    // ==========================================
    async function loadSeminars(userId) {
      log('Fetching seminars from GAS API...');
      try {
        const res = await fetch(GAS_API_URL + '?action=getSeminars');
        log('HTTP Status: ' + res.status);

        const seminars = await res.json();
        log('Received: ' + seminars.length + ' items');
        log('Data: ' + JSON.stringify(seminars).substring(0, 200));

        renderList(seminars, userId);

      } catch (err) {
        log('Fetch Error: ' + err.message);
        document.getElementById('app').innerHTML = '<p>データ取得失敗: ' + err.message + '</p>';
      }
    }

    // ==========================================
    // Render (変更なし)
    // ==========================================
    function esc(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function renderList(seminars, userId) {
      const app = document.getElementById('app');
      if (!seminars || seminars.length === 0) {
        app.innerHTML = '<p>現在募集中のセミナーはありません。</p>';
        return;
      }

      let html = '';
      seminars.forEach(s => {
        const applyUrl = FORM_BASE_URL +
          '?' + ENTRY_SEMINAR + '=' + encodeURIComponent(s.pid) +
          '&' + ENTRY_USER + '=' + encodeURIComponent(userId);

        let btnHtml = '';
        if (s.status === '募集中') {
          btnHtml = '<button class="btn" onclick="window.location.href=\'' + applyUrl + '\'">申し込む</button>';
        } else if (s.status === '満席') {
          btnHtml = '<button class="btn disabled" disabled>満席</button>';
        } else if (s.status === '申込前') {
          btnHtml = '<button class="btn disabled" disabled>申込開始前</button>';
        }

        html += '<div class="card">' +
          '<div class="date">' + esc(s.date) + ' <span style="font-size:0.8em;color:#666;">(' + esc(s.status) + ')</span></div>' +
          '<h2>' + esc(s.name) + '</h2>' +
          '<div class="info">' +
          '場所: ' + esc(s.venue) + '<br>' +
          '時間: ' + esc(s.time) + '<br>' +
          (s.comment ? '<span style="font-size:0.9em;color:#888;">' + esc(s.comment) + '</span>' : '') +
          '</div>' +
          btnHtml +
          '</div>';
      });
      app.innerHTML = html;
    }

    // Start
    main();
  </script>
</body>

</html>
