<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>„Çª„Éü„Éä„Éº‰∏ÄË¶ß</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      /* Lighter, more pastel aurora gradient for better contrast */
      background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
      margin: 0;
      padding: 0;
      color: #333;
      min-height: 100vh;
    }

    @keyframes gradient {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* Header Section (Liquid Glass) */
    header {
      background: rgba(255, 255, 255, 0.6);
      /* Increased opacity for legibility */
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      padding: 16px 20px;
      text-align: center;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 16px;
      color: #333;
      /* Dark text for contrast against light glass */
      font-weight: 700;
      letter-spacing: 0.05em;
      white-space: nowrap;
      /* Remove strong shadow on text */
    }

    /* PCM Dots */
    .pcm-dots {
      display: flex;
      gap: 4px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .Thinker {
      background-color: #1a73e8;
    }

    .Persister {
      background-color: #9c27b0;
    }

    .Promoter {
      background-color: #f44336;
    }

    .Harmonizer {
      background-color: #ff9800;
    }

    .Imaginer {
      background-color: #795548;
    }

    .Rebel {
      background-color: #fdd835;
    }

    /* Container */
    #app {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 16px 40px 16px;
    }

    #debug {
      background: rgba(0, 0, 0, 0.85);
      color: #0f0;
      font-size: 11px;
      padding: 10px;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 180px;
      overflow-y: scroll;
      z-index: 9999;
      display: none;
    }

    /* Card Design (Liquid Glass - High Contrast) */
    .card {
      background: rgba(255, 255, 255, 0.75);
      /* Much whiter background for readability */
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s;
      position: relative;
      overflow: hidden;
      color: #2c3e50;
    }

    /* Specular Highlight - Subtle */
    .card::before {
      content: "";
      position: absolute;
      top: 0;
      left: -50%;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom right,
          rgba(255, 255, 255, 0.9) 0%,
          rgba(255, 255, 255, 0) 40%);
      transform: skewX(-20deg);
      pointer-events: none;
      opacity: 0.3;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
      background: rgba(255, 255, 255, 0.85);
      /* Almost opaque on hover */
      border-color: rgba(255, 255, 255, 0.9);
    }

    .card:active {
      transform: scale(0.98);
    }

    /* Status Badge */
    .status-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 0.05em;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      z-index: 2;
    }

    .status-open {
      color: #2e7d32;
      border: 1px solid #c8e6c9;
      background: #e8f5e9;
    }

    .status-full {
      color: #c62828;
      border: 1px solid #ffcdd2;
      background: #ffebee;
    }

    .status-wait {
      color: #616161;
      border: 1px solid #e0e0e0;
      background: #f5f5f5;
    }

    /* Typography */
    .date {
      color: #1976d2;
      /* Strong blue */
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }

    .date::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #1976d2;
      border-radius: 50%;
      margin-right: 8px;
    }

    .card h2 {
      font-size: 19px;
      margin: 0 0 16px 0;
      color: #111;
      /* Almost black for title */
      line-height: 1.4;
      position: relative;
      z-index: 1;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 8px 0;
      font-size: 13.5px;
      color: #333;
      /* Standard dark grey */
      margin-bottom: 16px;
      position: relative;
      z-index: 1;
    }

    .info-label {
      font-weight: bold;
      color: #555;
    }

    .comment-box {
      background: rgba(255, 255, 255, 0.6);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      color: #444;
      margin-bottom: 16px;
      line-height: 1.5;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Price Section */
    .price-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }

    .price-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 11px;
      color: #666;
    }

    /* Center the first and last items differently */
    .price-item:first-child {
      align-items: flex-start;
    }

    .price-item:last-child {
      align-items: flex-end;
    }

    .price-val {
      font-size: 14px;
      font-weight: bold;
      color: #222;
      margin-top: 2px;
    }

    /* Button */
    .btn {
      display: block;
      width: 100%;
      text-align: center;
      background: linear-gradient(135deg, #06c755 0%, #05b34c 100%);
      color: white;
      padding: 14px 0;
      border-radius: 50px;
      text-decoration: none;
      font-weight: bold;
      border: none;
      font-size: 15px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      z-index: 1;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(6, 199, 85, 0.3);
    }

    .btn.disabled {
      background: #e0e0e0;
      color: #9e9e9e;
      cursor: not-allowed;
      box-shadow: none;
    }

    .loading {
      text-align: center;
      margin-top: 50px;
    }
  </style>
</head>

<body>

  <header>
    <div class="pcm-dots">
      <span class="dot Thinker"></span>
      <span class="dot Persister"></span>
      <span style="font-size: 14px; line-height: 10px;">‚ù§Ô∏è</span>
    </div>
    <h1>Ê≠¶Â≤°‰º∏Âπ∏PCM„Çª„Éü„Éä„Éº</h1>
    <div class="pcm-dots">
      <span class="dot Harmonizer"></span>
      <span class="dot Imaginer"></span>
      <span class="dot Rebel"></span>
    </div>
  </header>

  <div id="app">
    <div class="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
  </div>
  <div id="debug">Debug Log:</div>

  <script>
    // ==========================================
    // Constants
    // ==========================================
    const LIFF_ID = '2009026233-a9Vi8lsj';
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyUjqY83pRshVoWoRJsCTWG8S1oiFLqzxqRZ69NoADNqkl1qnkf8iYyqT80OKskWA0IwA/exec';
    const FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdvMlF-nnf3qgebUwI4JrcnKddfQgyww16uT2qmM9MxgOb4sg/viewform';
    // ==========================================

    const ENTRY_SEMINAR = 'entry.100643207';
    const ENTRY_USER = 'entry.1734163930';

    // Check URL parameter for ?debug=true
    const urlParams = new URLSearchParams(window.location.search);
    const IS_DEBUG = urlParams.get('debug') === 'true';

    if (IS_DEBUG) {
      document.getElementById('debug').style.display = 'block';
    }

    function log(msg) {
      console.log(msg);
      if (IS_DEBUG) {
        const d = document.getElementById('debug');
        if (d) d.innerHTML += '\n[' + new Date().toLocaleTimeString() + '] ' + msg;
      }
    }

    function withTimeout(promise, ms) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error('TIMEOUT after ' + ms + 'ms')), ms))
      ]);
    }

    // ==========================================
    // Main
    // ==========================================
    async function main() {
      try {
        log('=== main start ===');
        log('URL: ' + window.location.href);
        log('Origin: ' + window.location.origin);
        log('LIFF ID: ' + LIFF_ID);

        // 1. LIFF ÂàùÊúüÂåñ
        log('Calling liff.init...');
        await withTimeout(liff.init({ liffId: LIFF_ID }), 10000);
        log('liff.init SUCCESS');

        log('isLoggedIn: ' + liff.isLoggedIn());
        log('isInClient: ' + liff.isInClient());
        log('OS: ' + liff.getOS());

        // 2. „É≠„Ç∞„Ç§„É≥„ÉÅ„Çß„ÉÉ„ÇØ
        if (!liff.isLoggedIn()) {
          log('Not logged in');
          document.getElementById('app').innerHTML =
            '<div style="text-align:center; padding:20px;">' +
            '<p>LINE„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</p>' +
            '<button class="btn" onclick="liff.login()">LINE„Åß„É≠„Ç∞„Ç§„É≥</button>' +
            '</div>';
          return;
        }

        // 3. „Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó
        const profile = await liff.getProfile();
        const userId = profile.userId;
        log('UserID: ' + userId);
        log('Name: ' + profile.displayName);

        // 4. „Çª„Éü„Éä„Éº‰∏ÄË¶ßÂèñÂæó
        loadSeminars(userId);

      } catch (err) {
        log('ERROR: ' + err.message);
        if (err.message.includes('TIMEOUT')) {
          document.getElementById('app').innerHTML =
            '<p>LIFFÂàùÊúüÂåñ„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ</p>' +
            '<p style="font-size:12px;color:#999;">LINE„Ç¢„Éó„É™ÂÜÖ„ÅßÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
        } else {
          document.getElementById('app').innerHTML = '<p>„Ç®„É©„Éº: ' + err.message + '</p>';
        }
      }
    }

    // ==========================================
    // ‚òÖ Â§âÊõ¥ÁÇπ: google.script.run ‚Üí fetch()
    // ==========================================
    async function loadSeminars(userId) {
      log('Fetching seminars from GAS API...');
      try {
        const res = await fetch(GAS_API_URL + '?action=getSeminars');
        log('HTTP Status: ' + res.status);

        const seminars = await res.json();
        log('Received: ' + seminars.length + ' items');
        log('Data: ' + JSON.stringify(seminars).substring(0, 200));

        renderList(seminars, userId);

      } catch (err) {
        log('Fetch Error: ' + err.message);
        document.getElementById('app').innerHTML = '<p>„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó: ' + err.message + '</p>';
      }
    }

    // ==========================================
    // Render (Â§âÊõ¥„Å™„Åó)
    // ==========================================
    function esc(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function renderList(seminars, userId) {
      const app = document.getElementById('app');
      if (!seminars || seminars.length === 0) {
        app.innerHTML = '<p style="text-align:center;">ÁèæÂú®ÂãüÈõÜ‰∏≠„ÅÆ„Çª„Éü„Éä„Éº„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
        return;
      }

      let html = '';
      seminars.forEach(s => {
        const applyUrl = FORM_BASE_URL +
          '?' + ENTRY_SEMINAR + '=' + encodeURIComponent(s.pid) +
          '&' + ENTRY_USER + '=' + encodeURIComponent(userId);

        // Status Badge Logic
        let badgeClass = 'status-wait';
        if (s.status === 'ÂãüÈõÜ‰∏≠') badgeClass = 'status-open';
        if (s.status === 'Ê∫ÄÂ∏≠') badgeClass = 'status-full';

        // Button Logic
        let btnHtml = '';
        if (s.status === 'ÂãüÈõÜ‰∏≠') {
          btnHtml = `<button class="btn" onclick="window.location.href='${applyUrl}'">Áî≥„ÅóËæº„ÇÄ</button>`;
        } else if (s.status === 'Ê∫ÄÂ∏≠') {
          btnHtml = `<button class="btn disabled" disabled>Ê∫ÄÂ∏≠</button>`;
        } else if (s.status === 'Áî≥ËæºÂâç') {
          btnHtml = `<button class="btn disabled" disabled>Áî≥ËæºÈñãÂßãÂâç</button>`;
        }

        html += `
            <div class="card">
              <div class="status-badge ${badgeClass}">${esc(s.status)}</div>
              <div class="date">${esc(s.date)}</div>
              <h2>${esc(s.name)}</h2>
              
              <div class="info-grid">
                <div class="info-label">Â†¥ÊâÄ</div>
                <div>${esc(s.venue)}</div>
                <div class="info-label">ÊôÇÈñì</div>
                <div>${esc(s.time)}</div>
              </div>

              ${s.comment ? `<div class="comment-box">üí° ${esc(s.comment)}</div>` : ''}
              
              <div class="price-row">
                 <div class="price-item">
                   <span>ÂàùÂèóË¨õ</span>
                   <span class="price-val">¬•${Number(s.fee_new).toLocaleString()}</span>
                 </div>
                 <div class="price-item">
                   <span>ÂÜçÂèóË¨õ</span>
                   <span class="price-val">¬•${Number(s.fee_repeat).toLocaleString()}</span>
                 </div>
                 <div class="price-item">
                   <span>ÊááË¶™‰ºö</span>
                   <span class="price-val">¬•${Number(s.fee_party || 0).toLocaleString()}</span>
                 </div>
              </div>

              ${btnHtml}
            </div>
          `;
      });
      app.innerHTML = html;
    }

    // Start
    main();
  </script>
</body>

</html>
